---
title: "Forecast Workflow"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Packages
```{r packages}
# remotes::install_github("cboettig/prov")
library(contentid)
library(prov)
library(aws.s3)
library(here)
library(lubridate)
library(tidyverse)
library(neon4cast)
library(neonUtilities)

source("R/NEONscripts/publish.R")
source("R/WarmModelForecast.R")
```

### Need these set to submit
```{r submitVars}
## Set the following  env vars: 
# AWS_ACCESS_KEY_ID=""
# AWS_SECRET_ACCESS_KEY=""
# AWS_DEFAULT_REGION="data"
# AWS_S3_ENDPOINT="ecoforecast.org"
```

# Read in NOAA temperature data
```{r wxData}
# Download most recent noadaforcast data
source("R/GetNOAAForecastData.R")

## Or read in most recent pull of data
noaa_wx <- noaa_wx %>% 
  select(siteID,date,daily_mean,daily_min,daily_max) %>% 
  mutate(source='noaa')

all_wx <- rbind(neon_wx,noaa_wx)
rm(neon_wx,noaa_wx)

# Apply GDD function which will fill in missing temp data and calculate GDD values
GDD <- calcGDDfun(temp_df=all_wx,targets_df = targets,int_method = "spline")

# Add in day of year
GDD$day <- yday(GDD$date)

# For each site, check that target dates have matching weather dates
for(site in sites){
  
  targs <- filter(targets,siteID==site & time <= Sys.Date())
  wx <- filter(GDD,siteID==site & date <= Sys.Date())
  x = as.Date(setdiff(as.Date(targs$time),as.Date(wx$date)))
  
  if(length(x)>0) print(paste0("Targets for ",site," missing wx for",x))
  
}
rm(all_wx,wx,x,site,targs)

```


# Read in target data and filter for the most recent week to inform G_init
```{r targetData}


```


# Read in model parameters for each site
```{r modelParams}

## STILL NEED TO WRITE THIS OUTPUT FROM 

```


# Forecast using NOAA temperature data -- make sure it's updated. Bring in temp code chunk from ModelFitWorkflow
```{r forecastGCC}

forecast_df <- NULL

for(site in sites){
  
  
  
  
}

```


# Format to prepare for scoring
# Submit forecasted data

# Forecast GCC

# Get into correct format for succesful submission
```{r formatForSubmit}

```

# Submit forecast
```{r submitForecast}

publish(code = c("phenology-workflow.R", "nullModel_randomWalk_main.R", "randomWalkNullModelFunction.R"),
        data_out = c(forecast_file_name),
        prefix = "phenology/",
        bucket = "forecasts")

```

